# Backend API Deployment
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mellea-api
  namespace: mellea-system
  labels:
    app.kubernetes.io/part-of: mellea
    app.kubernetes.io/component: api
    app.kubernetes.io/name: mellea-api
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: mellea-api
  template:
    metadata:
      labels:
        app.kubernetes.io/part-of: mellea
        app.kubernetes.io/component: api
        app.kubernetes.io/name: mellea-api
    spec:
      serviceAccountName: default
      initContainers:
        - name: init-permissions
          image: busybox:1.36
          command: ['sh', '-c', 'chown -R 999:999 /app/data/metadata /app/data/workspaces /app/data/artifacts']
          volumeMounts:
            - name: assets
              mountPath: /app/data/metadata
            - name: workspaces
              mountPath: /app/data/workspaces
            - name: artifacts
              mountPath: /app/data/artifacts
          securityContext:
            runAsUser: 0
      containers:
        - name: api
          image: mellea-backend:latest
          imagePullPolicy: Never  # For kind - images loaded locally
          ports:
            - containerPort: 8000
              name: http
          env:
            - name: MELLEA_ENVIRONMENT
              value: "development"
            - name: MELLEA_DEBUG
              value: "true"
            - name: MELLEA_DATA_DIR
              value: "/app/data"
            - name: MELLEA_REDIS_URL
              value: "redis://redis.mellea-system.svc.cluster.local:6379"
            - name: MELLEA_OTEL_ENABLED
              value: "false"  # Enable when collector is deployed
            - name: MELLEA_BUILD_BACKEND
              value: "kaniko"
            - name: MELLEA_REGISTRY_URL
              value: "kind-registry:5000"  # Kind's local registry (in-cluster address)
            - name: MELLEA_REGISTRY_INSECURE
              value: "true"  # Use HTTP for local Kind registry
          volumeMounts:
            - name: assets
              mountPath: /app/data/metadata
            - name: workspaces
              mountPath: /app/data/workspaces
            - name: artifacts
              mountPath: /app/data/artifacts
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 10
            periodSeconds: 15
          readinessProbe:
            httpGet:
              path: /ready
              port: 8000
            initialDelaySeconds: 5
            periodSeconds: 10
          startupProbe:
            httpGet:
              path: /startup
              port: 8000
            failureThreshold: 30
            periodSeconds: 2
      volumes:
        - name: assets
          persistentVolumeClaim:
            claimName: mellea-assets-pvc
        - name: workspaces
          persistentVolumeClaim:
            claimName: mellea-workspaces-pvc
        - name: artifacts
          persistentVolumeClaim:
            claimName: mellea-artifacts-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: mellea-api
  namespace: mellea-system
  labels:
    app.kubernetes.io/part-of: mellea
    app.kubernetes.io/component: api
spec:
  selector:
    app.kubernetes.io/name: mellea-api
  ports:
    - port: 8000
      targetPort: 8000
      name: http
  type: ClusterIP
---
# NodePort service for local access
apiVersion: v1
kind: Service
metadata:
  name: mellea-api-nodeport
  namespace: mellea-system
  labels:
    app.kubernetes.io/part-of: mellea
    app.kubernetes.io/component: api
spec:
  selector:
    app.kubernetes.io/name: mellea-api
  ports:
    - port: 8000
      targetPort: 8000
      nodePort: 30080
      name: http
  type: NodePort
