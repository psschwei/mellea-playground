#!/bin/bash
# Pre-push hook: Run CI checks before allowing push
# Install: git config core.hooksPath .githooks

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}=== Pre-push CI Checks ===${NC}"
echo

# Get repo root
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

# Track failures
FAILED=0

# Backend checks (always run if backend exists)
if [ -d "backend" ]; then
    echo -e "${YELLOW}[1/4] Backend: ruff lint${NC}"
    if ruff check backend/; then
        echo -e "${GREEN}✓ ruff passed${NC}"
    else
        echo -e "${RED}✗ ruff failed${NC}"
        FAILED=1
    fi
    echo

    echo -e "${YELLOW}[2/4] Backend: mypy type check${NC}"
    if mypy backend/ --ignore-missing-imports; then
        echo -e "${GREEN}✓ mypy passed${NC}"
    else
        echo -e "${RED}✗ mypy failed${NC}"
        FAILED=1
    fi
    echo

    echo -e "${YELLOW}[3/4] Backend: pytest${NC}"
    if pytest backend/tests/ -v --tb=short -q; then
        echo -e "${GREEN}✓ pytest passed${NC}"
    else
        echo -e "${RED}✗ pytest failed${NC}"
        FAILED=1
    fi
    echo
else
    echo -e "${YELLOW}Skipping backend checks (no backend directory)${NC}"
fi

# Frontend checks (only if frontend exists)
if [ -f "frontend/package.json" ]; then
    echo -e "${YELLOW}[4/4] Frontend: lint and type-check${NC}"
    cd frontend
    if npm run lint && npm run type-check; then
        echo -e "${GREEN}✓ frontend checks passed${NC}"
    else
        echo -e "${RED}✗ frontend checks failed${NC}"
        FAILED=1
    fi
    cd ..
    echo
else
    echo -e "${YELLOW}Skipping frontend checks (no frontend/package.json)${NC}"
fi

# Final result
if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}=== All CI checks passed! Push allowed. ===${NC}"
    exit 0
else
    echo -e "${RED}=== CI checks FAILED! Push blocked. ===${NC}"
    echo -e "${YELLOW}Fix the issues above and try again.${NC}"
    echo -e "${YELLOW}To skip this check (not recommended): git push --no-verify${NC}"
    exit 1
fi
